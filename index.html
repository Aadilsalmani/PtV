<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tourist Explorer</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Manifest for PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0078d7" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #map { flex: 1; height: 50%; position: relative; }

    #filter-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      z-index: 1000;
    }

    #filter-bar label {
      font-weight: 600;
      font-size: 14px;
    }

    #filter-bar select {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
    }

    #table-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f7f7f7;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #0078d7;
      color: white;
    }

    tr:hover {
      background-color: #eaf4ff;
    }

    #popularityFilterGroup {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    #popularityFilterGroup label {
      font-weight: 500;
      font-size: 13px;
      background: white;
      padding: 3px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }

    #popularityFilterGroup input[type="checkbox"] {
      margin-right: 4px;
    }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" style="
    position: fixed; inset: 0;
    background: white;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: bold; z-index: 2000;">
    ‚è≥ Loading nearby places...
  </div>

  <div id="map"></div>

  <!-- Floating filter bar -->
  <div id="filter-bar">
    <div id="popularityFilterGroup">
      <label><input type="checkbox" class="pop-check" value="Priority" checked> Priority</label>
      <label><input type="checkbox" class="pop-check" value="Tier I" checked> Tier I</label>
      <label><input type="checkbox" class="pop-check" value="Tier II" checked> Tier II</label>
      <label><input type="checkbox" class="pop-check" value="Tier III" checked> Tier III</label>
      <label><input type="checkbox" class="pop-check" value="Tier IV" checked> Tier IV</label>
      <label><input type="checkbox" class="pop-check" value="Tier V" checked> Tier V</label>
    </div>

    <label>Distance (km):</label>
    <select id="distanceFilter">
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="25" selected>25</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="All">All</option>
    </select>
  </div>

  <div id="table-container">
    <table id="places-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Popularity</th>
          <th>Distance (km)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    console.time('loadTime');

    const map = L.map('map').setView([28.6139, 77.2090], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const tableBody = document.querySelector('#places-table tbody');
    let allPlaces = [];
    let markers = [];
    let userLat, userLon;

    // Haversine distance (km)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) ** 2 +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // Load data
    fetch('data/tourist_data.csv')
      .then(res => res.text())
      .then(csv => Papa.parse(csv, { header: true, skipEmptyLines: true }))
      .then(results => {
        allPlaces = results.data.map(p => ({
          ...p,
          Latitude: parseFloat(p.Latitude),
          Longitude: parseFloat(p.Longitude)
        }));
        locateUser();
      });

    // Locate user
    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            userLat = pos.coords.latitude;
            userLon = pos.coords.longitude;
            map.setView([userLat, userLon], 12);
            L.marker([userLat, userLon]).addTo(map).bindPopup("You are here").openPopup();
            applyFilters(); // Default filters
          },
          err => {
            alert('Location access denied. Showing all data.');
            applyFilters(); // fallback
          }
        );
      } else {
        alert('Geolocation not supported');
        applyFilters();
      }
    }

    // Apply filters and render
    function applyFilters() {
      const selectedPopularity = Array.from(document.querySelectorAll('.pop-check:checked')).map(cb => cb.value);
      const distanceValue = document.getElementById('distanceFilter').value;
      tableBody.innerHTML = '';
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      let filtered = allPlaces.filter(p => {
        if (!p.Latitude || !p.Longitude) return false;
        let include = true;

        if (userLat && userLon)
          p.Distance = getDistance(userLat, userLon, p.Latitude, p.Longitude);
        else
          p.Distance = null;

        if (!selectedPopularity.includes(p.Popularity)) include = false;
        if (distanceValue !== "All" && p.Distance !== null && p.Distance > parseFloat(distanceValue)) include = false;

        return include;
      });

      if (userLat && userLon) filtered.sort((a, b) => a.Distance - b.Distance);

      // Limit visible markers for performance
      const visible = filtered.slice(0, 200);

      visible.forEach(p => {
        const marker = L.marker([p.Latitude, p.Longitude]).addTo(map);
        marker.bindPopup(
          `<b>${p.Name}</b><br>${p.Category}<br>${p.Popularity}<br>${p.Distance ? p.Distance.toFixed(2)+' km' : ''}`
        );
        markers.push(marker);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.Name}</td>
          <td>${p.Category}</td>
          <td>${p.Popularity}</td>
          <td>${p.Distance ? p.Distance.toFixed(2) : '-'}</td>
        `;
        row.addEventListener('click', () => {
          map.setView([p.Latitude, p.Longitude], 14);
          marker.openPopup();
        });
        tableBody.appendChild(row);
      });

      // Hide loading screen and log load time
      document.getElementById('loading-overlay').style.display = 'none';
      console.timeEnd('loadTime');
    }

    // Listen to checkbox and dropdown changes
    document.querySelectorAll('.pop-check').forEach(cb => cb.addEventListener('change', applyFilters));
    document.getElementById('distanceFilter').addEventListener('change', applyFilters);

    // Register service worker for PWA (if exists)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>
</body>
</html>
