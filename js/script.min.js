"use strict";console.time("loadTime");const map=L.map("map").setView([28.6139,77.209],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map);const tableBody=document.querySelector("#places-table tbody");let allPlaces=[],markers=[],userLat,userLon,userStatus=JSON.parse(localStorage.getItem("userStatus"))||{};function getDistance(e,t,a,o){const l=6371,n=(a-e)*Math.PI/180,i=(o-t)*Math.PI/180,s=Math.sin(n/2)**2+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(i/2)**2;return l*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}function locateUser(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{userLat=e.coords.latitude,userLon=e.coords.longitude,map.setView([userLat,userLon],12),L.marker([userLat,userLon]).addTo(map).bindPopup("📍 You are here").openPopup(),applyFilters()},e=>{console.warn("Location not available:",e.message),applyFilters()}):(alert("Geolocation not supported"),applyFilters())}function applyRowColor(e,t){const a={Visited:"#d6f5d6","Not Interested":"#f2f2f2","Spare/Skip":"#fff5cc","Want to Visit":"#ffffff"};t.style.backgroundColor=a[e]||"#fff"}function applyFilters(){const e=Array.from(document.querySelectorAll(".pop-check:checked")).map(e=>e.value),t=document.getElementById("distanceFilter").value,a=document.getElementById("statusFilter")?.value||"All";tableBody.innerHTML="",markers.forEach(e=>map.removeLayer(e)),markers=[];let o=allPlaces.filter(o=>{if(!o.Latitude||!o.Longitude)return!1;userLat&&userLon?o.Distance=getDistance(userLat,userLon,o.Latitude,o.Longitude):o.Distance=null;let l=e.includes(o.Popularity);return"All"!==t&&o.Distance&&o.Distance>parseFloat(t)&&(l=!1),(userStatus[o.Name]||"Want to Visit")!==a&&"All"!==a&&(l=!1),l});userLat&&userLon&&o.sort((e,t)=>e.Distance-t.Distance),o.slice(0,200).forEach(e=>{const t=L.marker([e.Latitude,e.Longitude]).addTo(map);t.bindPopup(`<b>${e.Name}</b><br>${e.CountryState||"Unknown Location"}<br>${e.Popularity}<br>${e.Distance?e.Distance.toFixed(2)+" km":""}`),markers.push(t);const a=document.createElement("tr");a.innerHTML=`<td>${e.Name}</td><td>${e.Popularity}</td><td>${e.Distance?e.Distance.toFixed(2):"-"}</td><td><select class="status-select" data-name="${e.Name}"><option value="Want to Visit">Want to Visit</option><option value="Visited">Visited</option><option value="Not Interested">Not Interested</option><option value="Spare/Skip">Spare/Skip</option></select></td>`;const o=a.querySelector(".status-select");o.value=userStatus[e.Name]||"Want to Visit",applyRowColor(o.value,a),o.addEventListener("change",t=>{const l=t.target.value;userStatus[e.Name]=l,localStorage.setItem("userStatus",JSON.stringify(userStatus)),applyRowColor(l,a)}),a.addEventListener("click",()=>{map.setView([e.Latitude,e.Longitude],14),t.openPopup()}),tableBody.appendChild(a)}),document.getElementById("loading-overlay").style.display="none",console.timeEnd("loadTime")}fetch("data/tourist_data.json").then(e=>e.json()).then(e=>{allPlaces=e,locateUser()}).catch(e=>console.error("Data load error:",e)),document.querySelectorAll(".pop-check").forEach(e=>e.addEventListener("change",applyFilters)),document.getElementById("distanceFilter").addEventListener("change",applyFilters),document.getElementById("statusFilter")?.addEventListener("change",applyFilters),lucide.createIcons();const filterToggle=document.getElementById("filter-toggle"),filterBar=document.getElementById("filter-bar"),filterOverlay=document.getElementById("filter-overlay");filterToggle.addEventListener("click",()=>{const e=filterBar.classList.toggle("show");filterOverlay.style.display=e?"block":"none"}),filterOverlay.addEventListener("click",()=>{filterBar.classList.remove("show"),filterOverlay.style.display="none"});const locateBtn=document.getElementById("locate-me");let userMarker=null;locateBtn.addEventListener("click",()=>{if(userLat&&userLon){map.flyTo([userLat,userLon],12,{animate:!0,duration:1.2}),userMarker?userMarker.setLatLng([userLat,userLon]).bindPopup("📍 You are here").openPopup():userMarker=L.marker([userLat,userLon]).addTo(map).bindPopup("📍 You are here").openPopup()}else navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{userLat=e.coords.latitude,userLon=e.coords.longitude,map.flyTo([userLat,userLon],12,{animate:!0,duration:1.2}),userMarker?userMarker.setLatLng([userLat,userLon]).bindPopup("📍 You are here").openPopup():userMarker=L.marker([userLat,userLon]).addTo(map).bindPopup("📍 You are here").openPopup()},e=>{alert("⚠️ Unable to access location. Please enable GPS or try again."),console.warn("Locate button error:",e.message)}):alert("❌ Geolocation not supported by your device/browser.")}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(()=>console.log("Service Worker registered")).catch(e=>console.error("SW registration failed:",e)),window.addEventListener("load",()=>{setTimeout(()=>{const e=document.getElementById("splash-screen");e&&(e.classList.add("fade-out"),setTimeout(()=>e.style.display="none",600))},1500)});
