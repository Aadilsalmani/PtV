console.time("loadTime");const map=L.map("map").setView([28.6139,77.209],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map);const tableBody=document.querySelector("#places-table tbody");let allPlaces=[],markers=[],userLat,userLon,userStatus=JSON.parse(localStorage.getItem("userStatus"))||{};function getDistance(e,t,a,l){const r=6371,n=(a-e)*Math.PI/180,o=(l-t)*Math.PI/180,s=Math.sin(n/2)**2+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(o/2)**2;return r*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}function locateUser(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{userLat=e.coords.latitude,userLon=e.coords.longitude,map.setView([userLat,userLon],12),L.marker([userLat,userLon]).addTo(map).bindPopup("You are here").openPopup(),applyFilters()},e=>{console.warn("Location not available:",e.message),applyFilters()}):(alert("Geolocation not supported"),applyFilters())}function applyRowColor(e,t){const a={Visited:"#d6f5d6","Not Interested":"#f2f2f2","Spare/Skip":"#fff5cc","Want to Visit":"#ffffff"};t.style.backgroundColor=a[e]||"#fff"}function applyFilters(){const e=Array.from(document.querySelectorAll(".pop-check:checked")).map(e=>e.value),t=document.getElementById("distanceFilter").value,a=document.getElementById("statusFilter")?.value||"All";tableBody.innerHTML="",markers.forEach(e=>map.removeLayer(e)),markers=[];let l=allPlaces.filter(l=>{if(!l.Latitude||!l.Longitude)return!1;let r=!0;return userLat&&userLon?l.Distance=getDistance(userLat,userLon,l.Latitude,l.Longitude):l.Distance=null,e.includes(l.Popularity)||(r=!1),"All"!==t&&null!==l.Distance&&l.Distance>parseFloat(t)&&(r=!1),(userStatus[l.Name]||"Want to Visit")!==a&&"All"!==a&&(r=!1),r});userLat&&userLon&&l.sort((e,t)=>e.Distance-t.Distance);l.slice(0,200).forEach(e=>{const t=L.marker([e.Latitude,e.Longitude]).addTo(map);t.bindPopup(`<b>${e.Name}</b><br>${e.CountryState||"Unknown Location"}<br>${e.Popularity}<br>${e.Distance?e.Distance.toFixed(2)+" km":""}`),markers.push(t);let r=document.createElement("tr");r.innerHTML=`<td>${e.Name}</td><td>${e.Popularity}</td><td>${e.Distance?e.Distance.toFixed(2):"-"}</td><td><select class="status-select" data-name="${e.Name}"><option value="Want to Visit">Want to Visit</option><option value="Visited">Visited</option><option value="Not Interested">Not Interested</option><option value="Spare/Skip">Spare/Skip</option></select></td>`;const n=r.querySelector(".status-select");n.value=userStatus[e.Name]||"Want to Visit",applyRowColor(n.value,r),n.addEventListener("change",t=>{const a=t.target.value;userStatus[e.Name]=a,localStorage.setItem("userStatus",JSON.stringify(userStatus)),applyRowColor(a,r)}),r.addEventListener("click",()=>{map.setView([e.Latitude,e.Longitude],14),t.openPopup()}),tableBody.appendChild(r)}),document.getElementById("loading-overlay").style.display="none",console.timeEnd("loadTime")}fetch("data/tourist_data.json").then(e=>e.json()).then(e=>{allPlaces=e,locateUser()}).catch(e=>console.error("Data load error:",e)),document.querySelectorAll(".pop-check").forEach(e=>e.addEventListener("change",applyFilters)),document.getElementById("distanceFilter").addEventListener("change",applyFilters),document.getElementById("statusFilter")&&document.getElementById("statusFilter").addEventListener("change",applyFilters),lucide.createIcons();const filterToggle=document.getElementById("filter-toggle"),filterBar=document.getElementById("filter-bar"),filterOverlay=document.getElementById("filter-overlay");filterToggle.addEventListener("click",()=>{const e=filterBar.classList.toggle("show");filterOverlay.style.display=e?"block":"none"}),filterOverlay.addEventListener("click",()=>{filterBar.classList.remove("show"),filterOverlay.style.display="none"});const locateBtn=document.getElementById("locate-me");locateBtn&&locateBtn.addEventListener("click",()=>{userLat&&userLon?(map.setView([userLat,userLon],12,{animate:!0}),L.popup().setLatLng([userLat,userLon]).setContent("📍 You are here").openOn(map)):locateUser()}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(()=>console.log("Service Worker registered")).catch(e=>console.error("SW registration failed:",e)),window.addEventListener("load",()=>{setTimeout(()=>{const e=document.getElementById("splash-screen");e&&(e.classList.add("fade-out"),setTimeout(()=>e.style.display="none",600))},1500)});