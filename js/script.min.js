console.time("loadTime");

const map = L.map("map").setView([28.6139, 77.209], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors",
}).addTo(map);

const tableBody = document.querySelector("#places-table tbody");
let allPlaces = [];
let markers = [];
let userLat, userLon;
let userStatus = JSON.parse(localStorage.getItem("userStatus")) || {};

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function locateUser() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        map.setView([userLat, userLon], 12);
        L.marker([userLat, userLon])
          .addTo(map)
          .bindPopup("You are here")
          .openPopup();
        applyFilters();
      },
      err => {
        console.warn("Location not available:", err.message);
        applyFilters();
      }
    );
  } else {
    alert("Geolocation not supported");
    applyFilters();
  }
}

function applyRowColor(status, row) {
  const colors = {
    Visited: "#d6f5d6",
    "Not Interested": "#f2f2f2",
    "Spare/Skip": "#fff5cc",
    "Want to Visit": "#ffffff",
  };
  row.style.backgroundColor = colors[status] || "#fff";
}

function applyFilters() {
  const selectedPopularity = Array.from(document.querySelectorAll(".pop-check:checked")).map(cb => cb.value);
  const distanceValue = document.getElementById("distanceFilter").value;
  const statusValue = document.getElementById("statusFilter")?.value || "All";

  tableBody.innerHTML = "";
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  let filtered = allPlaces.filter(p => {
    if (!p.Latitude || !p.Longitude) return false;
    if (userLat && userLon) p.Distance = getDistance(userLat, userLon, p.Latitude, p.Longitude);
    else p.Distance = null;

    let include = selectedPopularity.includes(p.Popularity);
    if (distanceValue !== "All" && p.Distance && p.Distance > parseFloat(distanceValue)) include = false;
    if ((userStatus[p.Name] || "Want to Visit") !== statusValue && statusValue !== "All") include = false;
    return include;
  });

  if (userLat && userLon) filtered.sort((a, b) => a.Distance - b.Distance);

  filtered.slice(0, 200).forEach(p => {
    const marker = L.marker([p.Latitude, p.Longitude]).addTo(map);
    marker.bindPopup(
      `<b>${p.Name}</b><br>${p.CountryState || "Unknown Location"}<br>${p.Popularity}<br>${p.Distance ? p.Distance.toFixed(2) + " km" : ""}`
    );
    markers.push(marker);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.Name}</td>
      <td>${p.Popularity}</td>
      <td>${p.Distance ? p.Distance.toFixed(2) : "-"}</td>
      <td>
        <select class="status-select" data-name="${p.Name}">
          <option value="Want to Visit">Want to Visit</option>
          <option value="Visited">Visited</option>
          <option value="Not Interested">Not Interested</option>
          <option value="Spare/Skip">Spare/Skip</option>
        </select>
      </td>
    `;

    const select = row.querySelector(".status-select");
    select.value = userStatus[p.Name] || "Want to Visit";
    applyRowColor(select.value, row);

    select.addEventListener("change", e => {
      const val = e.target.value;
      userStatus[p.Name] = val;
      localStorage.setItem("userStatus", JSON.stringify(userStatus));
      applyRowColor(val, row);
    });

    row.addEventListener("click", () => {
      map.setView([p.Latitude, p.Longitude], 14);
      marker.openPopup();
    });

    tableBody.appendChild(row);
  });

  document.getElementById("loading-overlay").style.display = "none";
  console.timeEnd("loadTime");
}

fetch("data/tourist_data.json")
  .then(res => res.json())
  .then(data => {
    allPlaces = data;
    locateUser();
  })
  .catch(err => console.error("Data load error:", err));

document.querySelectorAll(".pop-check").forEach(cb => cb.addEventListener("change", applyFilters));
document.getElementById("distanceFilter").addEventListener("change", applyFilters);
document.getElementById("statusFilter")?.addEventListener("change", applyFilters);
lucide.createIcons();

const locateBtn = document.getElementById("locate-me");
locateBtn.addEventListener("click", () => {
  if (userLat && userLon) {
    map.flyTo([userLat, userLon], 12, { animate: true, duration: 1.2 });
    L.popup()
      .setLatLng([userLat, userLon])
      .setContent("📍 You are here")
      .openOn(map);
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        map.flyTo([userLat, userLon], 12, { animate: true, duration: 1.2 });
        L.popup()
          .setLatLng([userLat, userLon])
          .setContent("📍 You are here")
          .openOn(map);
      },
      err => {
        alert("⚠️ Unable to access location. Please enable GPS or try again.");
      }
    );
  } else {
    alert("❌ Geolocation not supported by your device/browser.");
  }
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error("SW registration failed:", err));
}

window.addEventListener("load", () => {
  setTimeout(() => {
    const splash = document.getElementById("splash-screen");
    if (splash) {
      splash.classList.add("fade-out");
      setTimeout(() => splash.style.display = "none", 600);
    }
  }, 1500);
});
