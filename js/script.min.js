console.time("loadTime");const map=L.map("map").setView([28.6139,77.209],5);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(map);const tableBody=document.querySelector("#places-table tbody");let allPlaces=[],markers=[],userLat,userLon,userStatus=JSON.parse(localStorage.getItem("userStatus"))||{};function getDistance(e,t,a,r){const o=6371,n=(a-e)*Math.PI/180,l=(r-t)*Math.PI/180,c=Math.sin(n/2)**2+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(l/2)**2;return 2*o*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}function locateUser(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{userLat=e.coords.latitude,userLon=e.coords.longitude,map.setView([userLat,userLon],12),L.marker([userLat,userLon]).addTo(map).bindPopup("You are here").openPopup(),applyFilters()},()=>{alert("Location access denied. Showing all data."),applyFilters()}):(alert("Geolocation not supported"),applyFilters())}function applyFilters(){const e=Array.from(document.querySelectorAll(".pop-check:checked")).map(e=>e.value),t=document.getElementById("distanceFilter").value,a=document.getElementById("statusFilter")?.value||"All";tableBody.innerHTML="",markers.forEach(e=>map.removeLayer(e)),markers=[];let r=allPlaces.filter(r=>{if(!r.Latitude||!r.Longitude)return!1;let o=!0;return userLat&&userLon?r.Distance=getDistance(userLat,userLon,r.Latitude,r.Longitude):r.Distance=null,e.includes(r.Popularity)||(o=!1),"All"!==t&&null!==r.Distance&&r.Distance>parseFloat(t)&&(o=!1);const n=userStatus[r.Name]||"Want to Visit";return"All"!==a&&n!==a&&(o=!1),o});userLat&&userLon&&r.sort((e,t)=>e.Distance-t.Distance);r.slice(0,200).forEach(e=>{const t=L.marker([e.Latitude,e.Longitude]).addTo(map);t.bindPopup(`<b>${e.Name}</b><br>${e.Category}<br>${e.Popularity}<br>${e.Distance?e.Distance.toFixed(2)+" km":""}`),markers.push(t);const a=document.createElement("tr");a.innerHTML=`
      <td>${e.Name}</td>
      <td>${e.Category}</td>
      <td>${e.Popularity}</td>
      <td>${e.Distance?e.Distance.toFixed(2):"-"}</td>
      <td>
        <select class="status-select" data-name="${e.Name}">
          <option value="Want to Visit">Want to Visit</option>
          <option value="Visited">Visited</option>
          <option value="Not Interested">Not Interested</option>
          <option value="Spare/Skip">Spare/Skip</option>
        </select>
      </td>
    `,tableBody.appendChild(a);const r=a.querySelector(".status-select");userStatus[e.Name]&&(r.value=userStatus[e.Name]),applyRowColor(r.value,a),r.addEventListener("change",t=>{const r=t.target.value;userStatus[e.Name]=r,localStorage.setItem("userStatus",JSON.stringify(userStatus)),applyRowColor(r,a),applyFilters()}),a.addEventListener("click",()=>{map.setView([e.Latitude,e.Longitude],14),t.openPopup()})}),document.getElementById("loading-overlay").style.display="none",console.timeEnd("loadTime")}function applyRowColor(e,t){const a={Visited:"#d6f5d6","Not Interested":"#f2f2f2","Spare/Skip":"#fff5cc","Want to Visit":"#ffffff"};t.style.backgroundColor=a[e]||"#fff"}fetch("data/tourist_data.json").then(e=>e.json()).then(e=>{allPlaces=e,locateUser()}),document.querySelectorAll(".pop-check").forEach(e=>e.addEventListener("change",applyFilters)),document.getElementById("distanceFilter").addEventListener("change",applyFilters),document.getElementById("statusFilter").addEventListener("change",applyFilters),lucide.createIcons();const filterToggle=document.getElementById("filter-toggle"),filterBar=document.getElementById("filter-bar"),filterOverlay=document.getElementById("filter-overlay");filterToggle.addEventListener("click",()=>{const e=filterBar.classList.toggle("show");filterOverlay.style.display=e?"block":"none"}),filterOverlay.addEventListener("click",()=>{filterBar.classList.remove("show"),filterOverlay.style.display="none"}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(()=>console.log("Service Worker registered")).catch(e=>console.error("SW registration failed:",e)),window.addEventListener("load",()=>{setTimeout(()=>{const e=document.getElementById("splash-screen");e&&(e.style.display="none")},2e3)});
